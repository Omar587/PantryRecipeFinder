@model RecipeFinder.Models.Recipe
@inject Microsoft.AspNetCore.Identity.SignInManager<RecipeFinder.Models.Customer> SignInManager
@inject Microsoft.AspNetCore.Identity.UserManager<RecipeFinder.Models.Customer> UserManager

@{
    ViewData["Title"] = Model.Name;
    var userId = 0;
    var userRating = 0;
    RecipeNote userNote = null;

    if (SignInManager.IsSignedIn(User))
    {
        var user = await UserManager.GetUserAsync(User);
        userId = user.Id;
        userNote = Model.Notes?.FirstOrDefault(n => n.CustomerId == userId);
        var existingRating = Model.Ratings?.FirstOrDefault(r => r.CustomerId == userId);
        userRating = existingRating?.Rating ?? 0;
    }

    var hasInstructions = Model.Instructions != null && Model.Instructions.Any();
    var sortedInstructions = hasInstructions
        ? Model.Instructions.OrderBy(i => i.StepNumber).ToList()
        : new List<RecipeInstructions>();
}

<style>
    /* â”€â”€â”€ Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
        background: #FFF8F0;
        font-family: 'Georgia', 'Times New Roman', serif;
        color: #3E2723;
        -webkit-font-smoothing: antialiased;
    }

    /* â”€â”€â”€ Hero â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .recipe-hero {
        position: relative;
        height: 62vh;
        min-height: 400px;
        overflow: hidden;
        border-radius: 0 0 44px 44px;
        margin: -1rem -1rem 0 -1rem;
    }

    .recipe-hero-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: center 45%;
        filter: brightness(0.62) saturate(1.1);
        transition: transform 7s ease;
        will-change: transform;
    }

    .recipe-hero:hover .recipe-hero-image {
        transform: scale(1.04);
    }

    .hero-gradient {
        position: absolute;
        inset: 0;
        background: linear-gradient(
            to top,
            rgba(30,14,8,0.97) 0%,
            rgba(30,14,8,0.55) 38%,
            transparent 65%
        );
    }

    .hero-content {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 2.5rem 2rem;
        max-width: 1200px;
        margin: 0 auto;
        animation: fadeUp 0.55s cubic-bezier(0.4, 0, 0.2, 1) both;
    }

    /* centres hero-content inside the hero when max-width kicks in */
    .recipe-hero > .hero-content {
        left: 50%;
        transform: translateX(-50%);
        width: 100%;
    }

    .recipe-title {
        font-size: clamp(1.9rem, 5vw, 3.4rem);
        font-weight: 700;
        color: #fff;
        line-height: 1.1;
        margin-bottom: 1rem;
        letter-spacing: -0.3px;
        text-shadow: 0 2px 24px rgba(0,0,0,0.45);
    }

    .recipe-meta {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        flex-wrap: wrap;
    }

    .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.42rem 1.05rem;
        border-radius: 999px;
        font-family: system-ui, -apple-system, sans-serif;
        font-size: 0.82rem;
        font-weight: 600;
        letter-spacing: 0.25px;
        white-space: nowrap;
    }

    .badge-sienna { background: #E67E22; color: #fff; }

    .badge-rating {
        background: rgba(255,255,255,0.95);
        color: #3E2723;
        backdrop-filter: blur(8px);
        box-shadow: 0 2px 12px rgba(62,39,35,0.07);
    }

    .badge-rating .star { color: #F39C12; }

    /* â”€â”€â”€ Back Button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .back-button {
        position: absolute;
        top: 1.5rem;
        left: 1.75rem;
        z-index: 20;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        background: rgba(255,255,255,0.92);
        color: #3E2723;
        padding: 0.6rem 1.3rem;
        border-radius: 999px;
        font-family: system-ui, sans-serif;
        font-size: 0.88rem;
        font-weight: 600;
        text-decoration: none;
        box-shadow: 0 2px 12px rgba(62,39,35,0.07);
        backdrop-filter: blur(10px);
        transition: all 0.22s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .back-button:hover {
        background: #fff;
        color: #E67E22;
        transform: translateY(-2px);
        box-shadow: 0 4px 24px rgba(62,39,35,0.11);
    }

    /* â”€â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .content-wrapper {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2.5rem 2rem 4rem;
    }

    .page-grid {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 2rem;
        align-items: start;
    }

    /* â”€â”€â”€ Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card {
        background: #fff;
        border-radius: 20px;
        padding: 1.75rem;
        box-shadow: 0 2px 12px rgba(62,39,35,0.07);
        border: 1px solid rgba(245,230,211,0.6);
        transition: box-shadow 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card:hover {
        box-shadow: 0 4px 24px rgba(62,39,35,0.11);
    }

    .section-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: #3E2723;
        margin-bottom: 1.25rem;
        display: flex;
        align-items: center;
        gap: 0.65rem;
    }

    .section-title::before {
        content: '';
        display: block;
        width: 4px;
        height: 1.3rem;
        background: #E67E22;
        border-radius: 2px;
        flex-shrink: 0;
    }

    /* â”€â”€â”€ Quick Info Grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.85rem;
        margin-bottom: 1.5rem;
    }

    .info-box {
        background: linear-gradient(135deg, #F5E6D3 0%, #FFF8F0 100%);
        border: 1px solid rgba(230,126,34,0.12);
        border-radius: 12px;
        padding: 1.1rem 0.75rem;
        text-align: center;
    }

    .info-box-value {
        display: block;
        font-size: 1.75rem;
        font-weight: 700;
        color: #E67E22;
        line-height: 1;
        margin-bottom: 0.3rem;
    }

    .info-box-label {
        font-family: system-ui, sans-serif;
        font-size: 0.72rem;
        font-weight: 600;
        color: #8B4513;
        text-transform: uppercase;
        letter-spacing: 0.6px;
    }

    /* â”€â”€â”€ Favorite Button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .favorite-btn {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.65rem;
        padding: 0.9rem 1.5rem;
        border: none;
        border-radius: 999px;
        font-family: system-ui, sans-serif;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.22s cubic-bezier(0.4, 0, 0.2, 1);
        background: linear-gradient(135deg, #E67E22 0%, #D4845F 100%);
        color: #fff;
        box-shadow: 0 4px 16px rgba(230,126,34,0.28);
    }

    .favorite-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 22px rgba(230,126,34,0.38);
    }

    .favorite-btn:active { transform: translateY(0); }

    .favorite-btn.favorited {
        background: linear-gradient(135deg, #C0392B 0%, #E74C3C 100%);
        box-shadow: 0 4px 16px rgba(192,57,43,0.28);
    }

    /* â”€â”€â”€ Star Rating â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .rating-card {
        background: linear-gradient(135deg, #FFF8F0 0%, #FFE8D6 100%);
        border: 1.5px solid rgba(230,126,34,0.15);
        border-radius: 12px;
        padding: 1.25rem;
        margin-top: 1rem;
        text-align: center;
    }

    .rating-card-title {
        font-family: system-ui, sans-serif;
        font-size: 0.88rem;
        font-weight: 600;
        color: #3E2723;
        margin-bottom: 0.85rem;
    }

    .star-row {
        display: flex;
        justify-content: center;
        gap: 0.3rem;
        font-size: 2.2rem;
        margin-bottom: 0.5rem;
        line-height: 1;
    }

    .star-row span {
        color: #DDD;
        cursor: pointer;
        transition: color 0.15s, transform 0.15s;
        user-select: none;
        display: inline-block;
    }

    .star-row span.filled  { color: #F39C12; }
    .star-row span.hovered { color: #F39C12; transform: scale(1.18); }

    .rating-msg {
        font-family: system-ui, sans-serif;
        font-size: 0.8rem;
        color: #8B4513;
        min-height: 1.2rem;
        transition: color 0.2s;
    }

    .rating-msg.success { color: #27AE60; font-weight: 600; }
    .rating-msg.error   { color: #C0392B; }

    /* â”€â”€â”€ Login Prompt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .login-prompt {
        background: linear-gradient(135deg, #E8F5E9, #C8E6C9);
        border-left: 4px solid #4CAF50;
        border-radius: 12px;
        padding: 1.1rem 1.25rem;
        color: #2E7D32;
        font-family: system-ui, sans-serif;
        font-size: 0.9rem;
        line-height: 1.5;
    }

    .login-prompt a { color: #1B5E20; font-weight: 600; }

    /* â”€â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tab-bar {
        display: flex;
        gap: 0;
        border-bottom: 2px solid #F5E6D3;
        margin-bottom: 1.5rem;
    }

    .tab-btn {
        background: none;
        border: none;
        padding: 0.75rem 1.5rem;
        font-family: system-ui, sans-serif;
        font-size: 0.95rem;
        font-weight: 600;
        color: #8B4513;
        cursor: pointer;
        position: relative;
        transition: color 0.2s;
        white-space: nowrap;
    }

    .tab-btn::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 2px;
        background: #E67E22;
        border-radius: 2px 2px 0 0;
        transform: scaleX(0);
        transition: transform 0.22s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .tab-btn.active { color: #E67E22; }
    .tab-btn.active::after { transform: scaleX(1); }
    .tab-btn:hover { color: #E67E22; }

    .tab-panel { display: none; animation: fadeIn 0.25s ease; }
    .tab-panel.active { display: block; }

    /* â”€â”€â”€ Ingredient List â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .ingredient-list { list-style: none; }

    .ingredient-item {
        display: flex;
        align-items: flex-start;
        gap: 0.9rem;
        padding: 0.85rem 0;
        border-bottom: 1px solid #F5E6D3;
    }

    .ingredient-item:last-child { border-bottom: none; }

    .ingredient-check {
        flex-shrink: 0;
        width: 1.5rem;
        height: 1.5rem;
        border-radius: 50%;
        background: linear-gradient(135deg, #E67E22, #D4845F);
        color: #fff;
        font-size: 0.7rem;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 0.15rem;
        font-weight: 700;
    }

    .ingredient-amount {
        font-weight: 700;
        color: #E67E22;
        margin-right: 0.25rem;
    }

    .ingredient-name { color: #3E2723; }

    .ingredient-category {
        font-family: system-ui, sans-serif;
        font-size: 0.75rem;
        color: #8B4513;
        background: #F5E6D3;
        padding: 0.15rem 0.5rem;
        border-radius: 999px;
        margin-left: 0.4rem;
        white-space: nowrap;
    }

    /* â”€â”€â”€ Instructions List â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .instructions-list { list-style: none; counter-reset: steps; }

    .instruction-item {
        display: flex;
        gap: 1.25rem;
        padding: 1.4rem 0;
        border-bottom: 1px solid #F5E6D3;
        animation: fadeUp 0.3s cubic-bezier(0.4, 0, 0.2, 1) both;
    }

    .instruction-item:last-child { border-bottom: none; }

    .step-number {
        flex-shrink: 0;
        width: 2.4rem;
        height: 2.4rem;
        border-radius: 50%;
        background: #3E2723;
        color: #fff;
        font-family: system-ui, sans-serif;
        font-size: 0.9rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 0.1rem;
        box-shadow: 0 2px 8px rgba(62,39,35,0.2);
    }

    .step-text {
        font-size: 1rem;
        line-height: 1.7;
        color: #3E2723;
        padding-top: 0.35rem;
    }

    .instructions-empty {
        font-family: system-ui, sans-serif;
        color: #8B4513;
        text-align: center;
        padding: 2.5rem 1rem;
        font-size: 0.95rem;
        opacity: 0.7;
    }

    /* â”€â”€â”€ Tags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tag-cloud {
        display: flex;
        flex-wrap: wrap;
        gap: 0.6rem;
        padding-top: 0.25rem;
    }

    .tag-pill {
        font-family: system-ui, sans-serif;
        font-size: 0.82rem;
        font-weight: 500;
        color: #8B4513;
        background: linear-gradient(135deg, #F5E6D3, #FFF8F0);
        border: 1px solid rgba(230,126,34,0.18);
        padding: 0.38rem 1rem;
        border-radius: 999px;
        transition: all 0.18s;
        cursor: default;
    }

    .tag-pill:hover {
        background: #E67E22;
        color: #fff;
        border-color: transparent;
        transform: translateY(-2px);
    }

    /* â”€â”€â”€ Notes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .notes-section {
        background: #FFFBEA;
        border: 1.5px solid rgba(243,156,18,0.25);
        border-left: 4px solid #F39C12;
        border-radius: 20px;
        padding: 1.75rem;
        margin-top: 1.5rem;
    }

    .notes-textarea {
        width: 100%;
        border: 1.5px solid #F5E6D3;
        border-radius: 12px;
        padding: 0.9rem 1rem;
        font-family: 'Georgia', serif;
        font-size: 0.95rem;
        line-height: 1.6;
        resize: vertical;
        background: #fff;
        color: #3E2723;
        transition: border-color 0.2s, box-shadow 0.2s;
        min-height: 110px;
    }

    .notes-textarea:focus {
        outline: none;
        border-color: #E67E22;
        box-shadow: 0 0 0 3px rgba(230,126,34,0.1);
    }

    .save-note-btn {
        margin-top: 0.85rem;
        background: #E67E22;
        color: #fff;
        border: none;
        padding: 0.65rem 1.75rem;
        border-radius: 999px;
        font-family: system-ui, sans-serif;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .save-note-btn:hover {
        background: #C96A10;
        transform: translateY(-1px);
    }

    .saved-note-display {
        background: #fff;
        border: 1.5px dashed #F39C12;
        border-radius: 12px;
        padding: 1.25rem;
        margin-top: 1rem;
    }

    .note-text {
        font-size: 0.97rem;
        line-height: 1.65;
        color: #3E2723;
        margin-bottom: 0.85rem;
        white-space: pre-wrap;
    }

    .note-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-family: system-ui, sans-serif;
        font-size: 0.8rem;
        color: #8B4513;
    }

    .note-action-btn {
        background: none;
        border: none;
        font-family: system-ui, sans-serif;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        padding: 0;
        text-decoration: underline;
    }

    .note-action-btn.edit   { color: #E67E22; }
    .note-action-btn.delete { color: #C0392B; margin-left: 0.85rem; }
    .note-action-btn:hover  { opacity: 0.75; }

    /* â”€â”€â”€ Animations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @@keyframes fadeUp {
        from { opacity: 0; transform: translateY(18px); }
        to   { opacity: 1; transform: translateY(0); }
    }

    @@keyframes fadeIn {
        from { opacity: 0; }
        to   { opacity: 1; }
    }

    /* â”€â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @@media (max-width: 900px) {
        .page-grid {
            grid-template-columns: 1fr;
        }
    }

    @@media (max-width: 576px) {
        .recipe-title { font-size: 1.8rem; }

        .info-grid { grid-template-columns: 1fr 1fr; }

        .back-button {
            top: 1rem;
            left: 1rem;
            padding: 0.5rem 1rem;
            font-size: 0.82rem;
        }

        .tab-btn { padding: 0.65rem 1rem; font-size: 0.88rem; }
    }
</style>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HERO â•â• -->
<div class="recipe-hero">
    @{
        var ext = System.IO.Path.GetExtension(Model.ImageUrl).ToLower();
        var retinaUrl = Model.ImageUrl.Replace(ext, $"@2x{ext}");
    }

    <img
        src="@Model.ImageUrl"
        alt="@Model.Name"
        class="recipe-hero-image"
        srcset="@Model.ImageUrl 1x, @retinaUrl 2x"
        sizes="100vw"
        loading="eager"
    />

    <div class="hero-gradient"></div>

    <a asp-action="Index" class="back-button">â† Recipes</a>

    <div class="hero-content">
        <h1 class="recipe-title">@Model.Name</h1>
        <div class="recipe-meta">
            <span class="badge badge-sienna">@Model.Cuisine</span>
            <span class="badge badge-sienna">@Model.Difficulty</span>
            <span class="badge badge-rating" id="ratingBadge">
                <span class="star">â˜…</span>
                <span id="badgeRatingValue">@Model.Rating.ToString("F1")</span>
                <span id="badgeRatingCount" style="opacity:0.65; font-size:0.8em;">(@Model.RatingCount)</span>
            </span>
        </div>
    </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CONTENT â•â• -->
<div class="content-wrapper">
    <div class="page-grid">

        <!-- â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <aside>
            <div class="card">
                <h3 class="section-title">Quick Info</h3>

                <div class="info-grid">
                    <div class="info-box">
                        <span class="info-box-value">@Model.PrepTime<small style="font-size:0.9rem;">m</small></span>
                        <span class="info-box-label">Prep</span>
                    </div>
                    <div class="info-box">
                        <span class="info-box-value">@Model.CookTime<small style="font-size:0.9rem;">m</small></span>
                        <span class="info-box-label">Cook</span>
                    </div>
                    <div class="info-box">
                        <span class="info-box-value">@Model.TotalTime()<small style="font-size:0.9rem;">m</small></span>
                        <span class="info-box-label">Total</span>
                    </div>
                    <div class="info-box">
                        <span class="info-box-value">@Model.Servings</span>
                        <span class="info-box-label">Servings</span>
                    </div>
                </div>

                @if (SignInManager.IsSignedIn(User))
                {
                    <!-- Favorite -->
                    <button class="favorite-btn @(ViewBag.IsFavorited == true ? "favorited" : "")"
                            id="favoriteBtn"
                            aria-label="Toggle favorite">
                        <span id="favoriteIcon" aria-hidden="true">â™¥</span>
                        <span id="favoriteText">@(ViewBag.IsFavorited == true ? "Saved to Favorites" : "Add to Favorites")</span>
                    </button>

                    <!-- Star Rating -->
                    <div class="rating-card">
                        <div class="rating-card-title" id="ratingTitle">
                            @(userRating > 0 ? "Your Rating" : "Rate This Recipe")
                        </div>
                        <div class="star-row" id="starRating" role="group" aria-label="Star rating">
                            @for (int s = 1; s <= 5; s++)
                            {
                                <span data-rating="@s" role="button" aria-label="@s star@(s > 1 ? "s" : "")">â˜…</span>
                            }
                        </div>
                        <div class="rating-msg" id="ratingMessage">
                            @(userRating > 0 ? $"You rated this {userRating}/5 â€” click to change" : "")
                        </div>
                    </div>
                }
                else
                {
                    <div class="login-prompt">
                        <strong>Join the community!</strong><br>
                        <a asp-controller="Account" asp-action="Login">Log in</a> to save favorites, rate recipes, and add personal notes.
                    </div>
                }
            </div>
        </aside>

        <!-- â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <main>
            <div class="card">
                <!-- Tab Bar -->
                <div class="tab-bar" role="tablist">
                    <button class="tab-btn active"
                            id="tab-ingredients"
                            role="tab"
                            aria-selected="true"
                            aria-controls="panel-ingredients">
                        ğŸ¥• Ingredients (@Model.Ingredients.Count)
                    </button>
                    <button class="tab-btn"
                            id="tab-instructions"
                            role="tab"
                            aria-selected="false"
                            aria-controls="panel-instructions">
                        ğŸ“‹ Instructions (@sortedInstructions.Count)
                    </button>
                </div>

                <!-- Ingredients Panel -->
                <div id="panel-ingredients"
                     class="tab-panel active"
                     role="tabpanel"
                     aria-labelledby="tab-ingredients">
                    <ul class="ingredient-list">
                        @foreach (var ingredient in Model.Ingredients)
                        {
                            <li class="ingredient-item">
                                <div class="ingredient-check" aria-hidden="true">âœ“</div>
                                <div>
                                    <span class="ingredient-amount">@ingredient.Amount @ingredient.Unit</span>
                                    <span class="ingredient-name">@ingredient.Name</span>
                                   
                                </div>
                            </li>
                        }
                    </ul>
                </div>

                <!-- Instructions Panel -->
                <div id="panel-instructions"
                     class="tab-panel"
                     role="tabpanel"
                     aria-labelledby="tab-instructions">

                    @if (sortedInstructions.Any())
                    {
                        <ol class="instructions-list">
                            @foreach (var step in sortedInstructions)
                            {
                                <li class="instruction-item"
                                    style="animation-delay: @(sortedInstructions.IndexOf(step) * 0.06)s">
                                    <div class="step-number" aria-label="Step @step.StepNumber">
                                        @step.StepNumber
                                    </div>
                                    <p class="step-text">@step.Instruction</p>
                                </li>
                            }
                        </ol>
                    }
                    else
                    {
                        <p class="instructions-empty">No instructions have been added for this recipe yet.</p>
                    }
                </div>
            </div>

            
            <!-- Tags -->
            @if (Model.Tags.Any())
            {
                <div class="card" style="margin-top: 1.5rem;">
                    <h3 class="section-title">Tags</h3>
                    <div class="tag-cloud">
                        @foreach (var tag in Model.Tags)
                        {
                            <span class="tag-pill">#@tag.Name</span>
                        }
                    </div>
                </div>
            }

            <!-- Personal Notes (auth only) -->
            @if (SignInManager.IsSignedIn(User))
            {
                <div class="notes-section">
                    <h3 class="section-title">My Personal Notes</h3>

                    @if (userNote != null)
                    {
                        <!-- Saved state -->
                        <div id="savedNote" class="saved-note-display">
                            <p class="note-text" id="noteContent">@userNote.NoteText</p>
                            <div class="note-footer">
                                <small id="noteDate">
                                    Saved @((userNote.UpdatedAt ?? userNote.CreatedAt).ToLocalTime().ToString("MMMM d, yyyy"))
                                </small>
                                <div>
                                    <button class="note-action-btn edit" id="editNoteBtn">Edit</button>
                                    <button class="note-action-btn delete" id="deleteNoteBtn">Delete</button>
                                </div>
                            </div>
                        </div>
                        <!-- Edit state (hidden by default) -->
                        <textarea class="notes-textarea" id="noteText" rows="5"
                                  style="display:none;"
                                  placeholder="Add your thoughts, modifications, or tipsâ€¦">@userNote.NoteText</textarea>
                        <button class="save-note-btn" id="saveNoteBtn" style="display:none;">Save Note</button>
                    }
                    else
                    {
                        <!-- New note state -->
                        <textarea class="notes-textarea" id="noteText" rows="5"
                                  placeholder="Add your thoughts, modifications, or tips for this recipeâ€¦"></textarea>
                        <button class="save-note-btn" id="saveNoteBtn">Save Note</button>

                        <div id="savedNote" class="saved-note-display" style="display:none;">
                            <p class="note-text" id="noteContent"></p>
                            <div class="note-footer">
                                <small id="noteDate"></small>
                                <div>
                                    <button class="note-action-btn edit" id="editNoteBtn">Edit</button>
                                    <button class="note-action-btn delete" id="deleteNoteBtn">Delete</button>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </main>
    </div>
</div>


@if (SignInManager.IsSignedIn(User))
{
    @section Scripts {
        <script>
        (() => {
            const recipeId = @Model.Id;

            // â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const tabBtns   = document.querySelectorAll('.tab-btn');
            const tabPanels = document.querySelectorAll('.tab-panel');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    tabBtns.forEach(b => {
                        b.classList.remove('active');
                        b.setAttribute('aria-selected', 'false');
                    });
                    tabPanels.forEach(p => p.classList.remove('active'));

                    btn.classList.add('active');
                    btn.setAttribute('aria-selected', 'true');
                    document.getElementById(btn.getAttribute('aria-controls')).classList.add('active');
                });
            });

            // â”€â”€ Star Rating â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const stars            = document.querySelectorAll('.star-row span');
            const ratingMsg        = document.getElementById('ratingMessage');
            const ratingTitle      = document.getElementById('ratingTitle');
            const badgeRatingValue = document.getElementById('badgeRatingValue');
            const badgeRatingCount = document.getElementById('badgeRatingCount');

            let committed = @userRating;

            function paintStars(n) {
                stars.forEach((s, i) => {
                    s.classList.toggle('filled', i < n);
                    s.classList.remove('hovered');
                });
            }

            paintStars(committed);

            // Hover preview
            stars.forEach(star => {
                star.addEventListener('mouseenter', () => {
                    const hov = +star.dataset.rating;
                    stars.forEach((s, i) => {
                        s.classList.toggle('hovered', i < hov);
                        s.classList.remove('filled');
                    });
                });
            });

            document.querySelector('.star-row').addEventListener('mouseleave', () => {
                stars.forEach(s => s.classList.remove('hovered'));
                paintStars(committed);
            });

            async function submitRating(rating) {
                ratingMsg.textContent = 'Savingâ€¦';
                ratingMsg.className = 'rating-msg';
                try {
                    const res  = await fetch('/Recipe/RateRecipe', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ recipeId, rating })
                    });
                    if (!res.ok) throw new Error();
                    const data = await res.json();

                    committed = rating;
                    paintStars(committed);
                    badgeRatingValue.textContent = data.newRating.toFixed(1);
                    badgeRatingCount.textContent = `(${data.newRatingCount})`;
                    ratingTitle.textContent = 'Your Rating';
                    ratingMsg.textContent = `âœ“ Rated ${rating}/5`;
                    ratingMsg.className = 'rating-msg success';
                    setTimeout(() => {
                        ratingMsg.textContent = 'Click a star to update';
                        ratingMsg.className = 'rating-msg';
                    }, 3000);
                } catch {
                    ratingMsg.textContent = 'Failed to save â€” please try again.';
                    ratingMsg.className = 'rating-msg error';
                }
            }

            async function removeRating() {
                ratingMsg.textContent = 'Removingâ€¦';
                ratingMsg.className = 'rating-msg';
                try {
                    const res  = await fetch('/Recipe/RemoveRating', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ recipeId })
                    });
                    if (!res.ok) throw new Error();
                    const data = await res.json();

                    committed = 0;
                    paintStars(0);
                    badgeRatingValue.textContent = data.newRating.toFixed(1);
                    badgeRatingCount.textContent = `(${data.newRatingCount})`;
                    ratingTitle.textContent = 'Rate This Recipe';
                    ratingMsg.textContent = 'Rating removed';
                    setTimeout(() => { ratingMsg.textContent = ''; }, 3000);
                } catch {
                    ratingMsg.textContent = 'Failed to remove â€” please try again.';
                    ratingMsg.className = 'rating-msg error';
                }
            }

            stars.forEach(star => {
                star.addEventListener('click', () => {
                    const val = +star.dataset.rating;
                    val === committed ? removeRating() : submitRating(val);
                });
            });

            // â”€â”€ Favorites â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const favoriteBtn  = document.getElementById('favoriteBtn');
            const favoriteText = document.getElementById('favoriteText');
            let isFavorited    = @(ViewBag.IsFavorited == true ? "true" : "false");

            favoriteBtn.addEventListener('click', async () => {
                try {
                    const res  = await fetch('/Recipe/ToggleFavorite', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ recipeId })
                    });
                    if (!res.ok) throw new Error();
                    const data = await res.json();
                    isFavorited = data.isFavorited;
                    favoriteBtn.classList.toggle('favorited', isFavorited);
                    favoriteText.textContent = isFavorited ? 'Saved to Favorites' : 'Add to Favorites';
                } catch {
                    alert('Failed to update favorites. Please try again.');
                }
            });

            // â”€â”€ Notes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const noteText    = document.getElementById('noteText');
            const saveNoteBtn = document.getElementById('saveNoteBtn');
            const savedNote   = document.getElementById('savedNote');
            const noteContent = document.getElementById('noteContent');
            const noteDate    = document.getElementById('noteDate');
            const editNoteBtn = document.getElementById('editNoteBtn');
            const deleteNoteBtn = document.getElementById('deleteNoteBtn');

            function showSavedState(text, dateStr) {
                noteText.style.display    = 'none';
                saveNoteBtn.style.display = 'none';
                savedNote.style.display   = 'block';
                noteContent.textContent   = text;
                noteDate.textContent      = 'Saved ' + new Date(dateStr).toLocaleDateString('en-US', {
                    year: 'numeric', month: 'long', day: 'numeric'
                });
            }

            function showEditState() {
                savedNote.style.display   = 'none';
                noteText.style.display    = 'block';
                saveNoteBtn.style.display = 'inline-block';
                noteText.focus();
            }

            saveNoteBtn?.addEventListener('click', async () => {
                const text = noteText.value.trim();
                if (!text) { noteText.focus(); return; }
                try {
                    const res = await fetch('/Recipe/SaveNote', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ recipeId, noteText: text })
                    });
                    if (!res.ok) throw new Error();
                    const data = await res.json();
                    showSavedState(text, data.createdAt);
                } catch {
                    alert('Failed to save note. Please try again.');
                }
            });

            editNoteBtn?.addEventListener('click', showEditState);

            deleteNoteBtn?.addEventListener('click', async () => {
                if (!confirm('Delete this note?')) return;
                try {
                    const res = await fetch('/Recipe/DeleteNote', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ recipeId })
                    });
                    if (!res.ok) throw new Error();
                    savedNote.style.display   = 'none';
                    noteText.value            = '';
                    noteText.style.display    = 'block';
                    saveNoteBtn.style.display = 'inline-block';
                } catch {
                    alert('Failed to delete note. Please try again.');
                }
            });
        })();
        </script>
    }
}